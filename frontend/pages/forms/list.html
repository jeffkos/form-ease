<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Formulaires - FormEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tremor: {
                            brand: {
                                faint: '#eff6ff',
                                muted: '#bfdbfe',
                                subtle: '#60a5fa',
                                DEFAULT: '#3b82f6',
                                emphasis: '#1d4ed8'
                            },
                            success: {
                                faint: '#f0fdf4',
                                muted: '#bbf7d0',
                                subtle: '#4ade80',
                                DEFAULT: '#22c55e',
                                emphasis: '#16a34a'
                            },
                            warning: {
                                faint: '#fffbeb',
                                muted: '#fed7aa',
                                subtle: '#fb923c',
                                DEFAULT: '#f97316',
                                emphasis: '#ea580c'
                            },
                            error: {
                                faint: '#fef2f2',
                                muted: '#fecaca',
                                subtle: '#f87171',
                                DEFAULT: '#ef4444',
                                emphasis: '#dc2626'
                            }
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui'],
                    },
                }
            }
        }
    </script>
    <style>
        .tremor-Card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .tremor-Card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }
        
        .form-list-item {
            background: white;
            transition: all 0.2s ease;
        }
        
        .form-list-item:hover {
            background: #f9fafb;
        }
        
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Pagination styles */
        .pagination-btn {
            min-width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .pagination-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Stats grid responsive */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        @media (min-width: 1024px) {
            .stats-container {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* Styles pour les boutons de notation */
        .rating-btn {
            transition: all 0.2s ease;
        }
        
        .rating-btn:hover {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }
        
        input[type="radio"]:checked + .rating-btn {
            background-color: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }
        
        /* Validation des champs */
        .border-red-500 {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444;
        }
        
        /* Stats grid similaire pour cohérence */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        @media (min-width: 1024px) {
            .stats-container {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* Amélioration de l'alignement des cartes */
        .form-card .flex-1 {
            flex: 1;
        }
        
        /* Responsive sidebar pour mobile */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -100%;
                transition: left 0.3s ease;
                z-index: 50;
            }
            
            .sidebar.open {
                left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Layout principal en grid avec container élargi -->
    <div class="min-h-screen max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-7 p-4 md:p-6 lg:p-8">
        <!-- Navigation Sidebar -->
        <aside class="bg-white rounded-lg shadow-sm border border-gray-200 h-fit">
            <!-- Logo -->
            <div class="flex items-center px-4 py-4 border-b border-gray-200">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                    <i class="ri-file-list-3-line text-white text-lg"></i>
                </div>
                <span class="ml-3 text-lg font-bold text-gray-900">FormEase</span>
            </div>

            <!-- Navigation Menu -->
            <nav class="p-4">
                <!-- Dashboard -->
                <a href="../dashboard/advanced.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-2">
                    <i class="ri-dashboard-line mr-3 text-sm"></i>
                    <span class="text-sm font-medium" data-i18n="dashboard">Tableau de bord</span>
                </a>

                <!-- Forms -->
                <div class="mt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2" data-i18n="forms">Formulaires</h3>
                    <a href="list.html" class="flex items-center px-3 py-2 text-blue-600 bg-blue-50 rounded-lg mb-1">
                        <i class="ri-file-list-2-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="formsList">Mes formulaires</span>
                    </a>
                    <a href="builder.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-tools-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="formBuilder">Créateur de formulaires</span>
                    </a>
                    <a href="ai-generator.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-robot-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="formAI">Formulaire généré IA</span>
                    </a>
                </div>

                <!-- Analytics -->
                <div class="mt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2" data-i18n="analytics">Analytics</h3>
                    <a href="#" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-bar-chart-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="analytics">Analytics</span>
                    </a>
                </div>

                <!-- Subscription -->
                <div class="mt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2" data-i18n="subscription">Abonnement</h3>
                    <a href="../subscription/manage.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-vip-crown-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="manageSubscription">Gérer l'abonnement</span>
                    </a>
                </div>

                <!-- Templates -->
                <div class="mt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2" data-i18n="templates">Modèles</h3>
                </div>

                <!-- Marketing & Communication -->
                <div class="mt-4">
                    <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2" data-i18n="marketing">Marketing</h3>
                    <a href="../newsletters/list.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-mail-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="newsletters">Newsletters</span>
                    </a>
                    <a href="../tracking/email-tracker.html" class="flex items-center px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i class="ri-radar-line mr-3 text-sm"></i>
                        <span class="text-sm" data-i18n="emailTracking">Trackers de mails</span>
                    </a>
                </div>

                <!-- User Profile & Actions -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <!-- User Info -->
                    <div class="flex items-center justify-start px-3 py-2 mb-4">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-start pl-2 mr-3">
                            <span class="text-white text-xs font-medium">JK</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">Jeff KOSI</p>
                            <p class="text-xs text-blue-600 font-medium">Premium</p>
                        </div>
                    </div>

                    <!-- User Actions -->
                    <div class="space-y-1">
                        <button class="flex items-center w-full px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="ri-user-settings-line mr-3 text-sm"></i>
                            <span class="text-sm" data-i18n="profile">Mon profil</span>
                        </button>
                        
                        <button class="flex items-center w-full px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="ri-notification-line mr-3 text-sm"></i>
                            <span class="text-sm" data-i18n="notifications">Notifications</span>
                        </button>
                        
                        <!-- Séparateur -->
                        <div class="border-t border-gray-200 my-2"></div>
                        
                        <!-- Déconnexion -->
                        <button class="flex items-center w-full px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                            <i class="ri-logout-box-line mr-3 text-sm"></i>
                            <span class="text-sm">Déconnexion</span>
                        </button>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="bg-white rounded-lg shadow-sm border border-gray-200 min-h-[calc(100vh-4rem)]">
            <!-- Header -->
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Mes Formulaires</h1>
                        <p class="text-gray-600 text-sm mt-1">Gérez et organisez tous vos formulaires</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Filtres -->
                        <select id="filterType" class="text-sm border border-gray-300 rounded-lg px-3 py-2 bg-white">
                            <option value="all">Tous les types</option>
                            <option value="manual">Créés manuellement</option>
                            <option value="ai">Générés IA</option>
                            <option value="free">Gratuits</option>
                            <option value="paid">Payants</option>
                        </select>
                        
                        <select id="filterStatus" class="text-sm border border-gray-300 rounded-lg px-3 py-2 bg-white">
                            <option value="all">Tous les statuts</option>
                            <option value="active">Actifs</option>
                            <option value="draft">Brouillons</option>
                            <option value="archived">Archivés</option>
                        </select>

                        <!-- Bouton créer -->
                        <button onclick="showCreateFormModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                            <i class="ri-add-line mr-2"></i>
                            Nouveau formulaire
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats rapides -->
            <div class="p-6 border-b border-gray-200">
                <div class="stats-container">
                    <div class="tremor-Card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 font-medium">Total formulaires</p>
                                <p class="text-xl font-bold text-gray-900" id="totalForms">12</p>
                            </div>
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="ri-file-list-line text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tremor-Card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 font-medium">Formulaires actifs</p>
                                <p class="text-xl font-bold text-green-600" id="activeForms">8</p>
                            </div>
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="ri-check-line text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tremor-Card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 font-medium">Réponses totales</p>
                                <p class="text-xl font-bold text-purple-600" id="totalResponses">2,847</p>
                            </div>
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="ri-bar-chart-line text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tremor-Card p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500 font-medium">Taux de conversion</p>
                                <p class="text-xl font-bold text-orange-600" id="conversionRate">87.5%</p>
                            </div>
                            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="ri-rocket-line text-orange-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des formulaires -->
            <div class="p-6">
                <div class="space-y-4" id="formsList">
                    <!-- Test manuel -->
                    <div class="form-list-item relative p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:shadow-sm transition-all duration-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4 flex-1 min-w-0">
                                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0 cursor-pointer hover:bg-blue-100" onclick="openResponsesModal(1)">
                                    <i class="ri-file-list-3-line text-blue-600 text-lg"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-base font-semibold text-gray-900 cursor-pointer hover:underline" onclick="openResponsesModal(1)">Formulaire de Test - Cliquez ici</h3>
                                    <p class="text-sm text-gray-600">Ceci est un test pour vérifier les clics</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Les formulaires seront générés dynamiquement -->
                </div>
                
                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        Affichage de <span id="startItem" class="font-medium text-gray-900">1</span> à <span id="endItem" class="font-medium text-gray-900">10</span> sur <span id="totalItems" class="font-medium text-gray-900">0</span> formulaires
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="prevPage" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <i class="ri-arrow-left-s-line mr-1"></i>Précédent
                        </button>
                        <div id="pageNumbers" class="flex space-x-1">
                            <!-- Les numéros de page seront générés ici -->
                        </div>
                        <button id="nextPage" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Suivant<i class="ri-arrow-right-s-line ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de visualisation du formulaire -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900" id="previewTitle">Aperçu du formulaire</h3>
                    <p class="text-sm text-gray-600 mt-1" id="previewDescription">Prévisualisation du formulaire sélectionné</p>
                </div>
                <button id="closePreviewModal" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]" id="previewContent">
                <!-- Le contenu du formulaire sera généré ici -->
            </div>
            <div class="border-t border-gray-200 p-4 bg-gray-50 flex justify-end space-x-3">
                <button id="editFromPreview" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="ri-edit-line mr-2"></i>Éditer ce formulaire
                </button>
                <button id="closePreview" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Fermer
                </button>
            </div>
        </div>
    </div>
    <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">QR Code du formulaire</h3>
                <button id="closeQrModal" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
            <div class="text-center">
                <div id="qrCodeContainer" class="bg-gray-50 rounded-lg p-6 mb-4">
                    <!-- QR Code sera généré ici -->
                    <div class="w-48 h-48 bg-gray-200 rounded-lg mx-auto flex items-center justify-center">
                        <i class="ri-qr-code-line text-6xl text-gray-400"></i>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-4">Scannez ce code pour accéder au formulaire</p>
                <button id="downloadQr" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="ri-download-line mr-2"></i>Télécharger
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <i class="ri-delete-bin-line text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Supprimer le formulaire</h3>
                    <p class="text-sm text-gray-600">Cette action est irréversible</p>
                </div>
            </div>
            <p class="text-gray-700 mb-6">Êtes-vous sûr de vouloir supprimer ce formulaire ? Toutes les données et réponses associées seront définitivement perdues.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDelete" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Annuler
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Supprimer définitivement
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de réponses du formulaire -->
    <div id="responsesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-7xl w-full mx-4 max-h-[95vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <div>
                    <h3 class="text-xl font-semibold text-gray-900" id="responsesModalTitle">Réponses du formulaire</h3>
                    <p class="text-sm text-gray-600 mt-1" id="responsesModalDesc">Gérez et analysez toutes les données soumises</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-500" id="responsesCount">0 réponses</span>
                    <button class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="exportAllResponses()">
                        <i class="ri-download-line mr-1"></i>Exporter tout
                    </button>
                    <button id="closeResponsesModal" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filtres avancés et recherche -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <!-- Première ligne : Recherche et filtres principaux -->
                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex-1">
                        <input type="text" id="searchResponses" placeholder="Rechercher dans les réponses..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onkeyup="filterResponses()">
                    </div>
                    <div>
                        <select id="filterByField" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterResponses()">
                            <option value="">Tous les champs</option>
                        </select>
                    </div>
                    <div>
                        <select id="sortResponses" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterResponses()">
                            <option value="newest">Plus récent</option>
                            <option value="oldest">Plus ancien</option>
                            <option value="name">Par nom</option>
                            <option value="email">Par email</option>
                        </select>
                    </div>
                    <button class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm" onclick="toggleAdvancedFilters()">
                        <i class="ri-filter-3-line mr-1"></i>Filtres avancés
                    </button>
                </div>

                <!-- Filtres avancés (cachés par défaut) -->
                <div id="advancedFilters" class="hidden">
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Filtres par données de formulaire</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="dynamicFilters">
                            <!-- Les filtres seront générés dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barre d'actions pour les sélections -->
            <div id="selectionActions" class="hidden px-6 py-3 bg-blue-50 border-b border-blue-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-blue-900">
                            <span id="selectedCount">0</span> réponse(s) sélectionnée(s)
                        </span>
                        <button class="text-sm text-blue-600 hover:text-blue-800" onclick="clearSelection()">
                            Désélectionner tout
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700" onclick="validateSelectedResponses()">
                            <i class="ri-check-line mr-1"></i>Valider sélection
                        </button>
                        <button class="px-3 py-1 text-sm bg-yellow-600 text-white rounded-lg hover:bg-yellow-700" onclick="archiveSelectedResponses()">
                            <i class="ri-archive-line mr-1"></i>Archiver sélection
                        </button>
                        <button class="px-3 py-1 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="sendEmailToSelectedResponses()">
                            <i class="ri-mail-line mr-1"></i>Envoyer emails
                        </button>
                        <button class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="exportSelectedResponses()">
                            <i class="ri-download-line mr-1"></i>Exporter sélection
                        </button>
                        <button class="px-3 py-1 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="deleteSelectedResponses()">
                            <i class="ri-delete-bin-line mr-1"></i>Supprimer sélection
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto" id="responsesModalContent">
                <!-- Table dynamique des réponses avec pagination -->
            </div>

            <!-- Pagination des réponses -->
            <div class="border-t border-gray-200 px-6 py-4 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        Affichage de <span id="responseStartItem" class="font-medium text-gray-900">1</span> à <span id="responseEndItem" class="font-medium text-gray-900">10</span> sur <span id="responseTotalItems" class="font-medium text-gray-900">0</span> réponses
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="prevResponsePage" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" onclick="goToResponsePage(currentResponsePage - 1)">
                            <i class="ri-arrow-left-s-line mr-1"></i>Précédent
                        </button>
                        <div id="responsePageNumbers" class="flex space-x-1">
                            <!-- Les numéros de page seront générés ici -->
                        </div>
                        <button id="nextResponsePage" class="px-3 py-2 text-sm text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" onclick="goToResponsePage(currentResponsePage + 1)">
                            Suivant<i class="ri-arrow-right-s-line ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale détaillée d'une réponse -->
    <div id="responseDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60 hidden">
        <div class="bg-white rounded-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <!-- En-tête avec info du formulaire -->
            <div class="bg-gradient-to-r from-tremor-brand-faint to-blue-50 px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-tremor-brand-DEFAULT rounded-lg flex items-center justify-center">
                            <i class="ri-file-text-line text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900" id="responseDetailFormTitle">Détails de la réponse</h3>
                            <p class="text-sm text-gray-600" id="responseDetailFormDesc">Formulaire de contact</p>
                        </div>
                    </div>
                    <button id="closeResponseDetailModal" class="text-gray-400 hover:text-gray-600 hover:bg-white/50 rounded-lg p-2 transition-colors">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                
                <!-- Métadonnées de la réponse -->
                <div class="mt-4 flex flex-wrap gap-4 text-sm">
                    <div class="flex items-center text-gray-600">
                        <i class="ri-calendar-line mr-2"></i>
                        <span id="responseDetailDate">Soumise le 8 janvier 2025</span>
                    </div>
                    <div class="flex items-center text-gray-600">
                        <i class="ri-user-line mr-2"></i>
                        <span id="responseDetailUser">Utilisateur anonyme</span>
                    </div>
                    <div class="flex items-center">
                        <span id="responseDetailStatus" class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">En attente</span>
                    </div>
                </div>
            </div>
            
            <!-- Contenu principal avec les réponses -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-6">
                    <div class="grid gap-6" id="responseDetailContent">
                        <!-- Le contenu sera généré dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- Pied de page avec actions -->
            <div class="border-t border-gray-200 bg-gray-50 px-6 py-4">
                <div class="flex flex-col sm:flex-row sm:justify-between gap-4">
                    <!-- Actions principales -->
                    <div class="flex flex-wrap gap-2">
                        <button class="inline-flex items-center px-4 py-2 bg-tremor-success-DEFAULT text-white rounded-lg hover:bg-tremor-success-emphasis text-sm font-medium transition-colors" onclick="validateCurrentResponse()">
                            <i class="ri-check-line mr-2"></i>Valider
                        </button>
                        <button class="inline-flex items-center px-4 py-2 bg-tremor-brand-DEFAULT text-white rounded-lg hover:bg-tremor-brand-emphasis text-sm font-medium transition-colors" onclick="sendEmailToCurrentResponse()">
                            <i class="ri-mail-line mr-2"></i>Envoyer email
                        </button>
                        <button class="inline-flex items-center px-4 py-2 bg-tremor-warning-DEFAULT text-white rounded-lg hover:bg-tremor-warning-emphasis text-sm font-medium transition-colors" onclick="archiveCurrentResponse()">
                            <i class="ri-archive-line mr-2"></i>Archiver
                        </button>
                    </div>
                    
                    <!-- Actions secondaires -->
                    <div class="flex flex-wrap gap-2">
                        <button class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm font-medium transition-colors" onclick="exportCurrentResponse()">
                            <i class="ri-download-line mr-2"></i>Exporter
                        </button>
                        <button class="inline-flex items-center px-4 py-2 bg-tremor-error-DEFAULT text-white rounded-lg hover:bg-tremor-error-emphasis text-sm font-medium transition-colors" onclick="deleteCurrentResponse()">
                            <i class="ri-delete-bin-line mr-2"></i>Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vérifier l'authentification
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '../auth/login.html';
        }

        // ===== SERVICE API CENTRALISÉ =====
        class ApiService {
            constructor() {
                this.baseURL = 'http://localhost:4000/api';
                this.token = localStorage.getItem('token');
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`,
                        ...options.headers
                    },
                    ...options
                };

                try {
                    showLoadingState(true);
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            localStorage.removeItem('token');
                            window.location.href = '../auth/login.html';
                            return;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    showLoadingState(false);
                    return data;
                } catch (error) {
                    showLoadingState(false);
                    console.error('API Error:', error);
                    showNotification(`Erreur API: ${error.message}`, 'error');
                    throw error;
                }
            }

            // === MÉTHODES CRUD POUR FORMULAIRES ===
            async getForms() {
                return this.request('/forms');
            }

            async getForm(id) {
                return this.request(`/forms/${id}`);
            }

            async createForm(formData) {
                return this.request('/forms', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
            }

            async updateForm(id, formData) {
                return this.request(`/forms/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
            }

            async deleteForm(id) {
                return this.request(`/forms/${id}`, {
                    method: 'DELETE'
                });
            }

            async duplicateForm(id) {
                return this.request(`/forms/${id}/duplicate`, {
                    method: 'POST'
                });
            }

            // === MÉTHODES POUR LES SOUMISSIONS ===
            async getFormSubmissions(formId) {
                return this.request(`/forms/${formId}/submissions`);
            }

            async validateSubmissions(submissionIds) {
                return this.request('/submissions/validate', {
                    method: 'POST',
                    body: JSON.stringify({ submissionIds })
                });
            }

            async archiveSubmissions(submissionIds) {
                return this.request('/submissions/archive', {
                    method: 'POST',
                    body: JSON.stringify({ submissionIds })
                });
            }

            async deleteSubmissions(submissionIds) {
                return this.request('/submissions/delete', {
                    method: 'POST',
                    body: JSON.stringify({ submissionIds })
                });
            }

            async exportSubmissions(formId, submissionIds = null, format = 'csv') {
                const params = new URLSearchParams();
                params.append('format', format);
                if (submissionIds?.length) {
                    params.append('submissions', submissionIds.join(','));
                }
                
                // Pour les exports, on retourne directement la réponse pour gérer le blob
                const url = `${this.baseURL}/forms/${formId}/submissions/export?${params}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${this.token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            }

            // === MÉTHODES POUR LES STATISTIQUES ===
            async getDashboardStats() {
                return this.request('/dashboard/stats');
            }

            async getFormStats(formId) {
                return this.request(`/forms/${formId}/stats`);
            }

            // === MÉTHODES POUR LES EMAILS ===
            async sendEmailToSubmissions(submissionIds, emailData) {
                return this.request('/submissions/send-email', {
                    method: 'POST',
                    body: JSON.stringify({
                        submissionIds,
        }

        // Instance globale du service API
        const apiService = new ApiService();

        // Fonction pour afficher/masquer l'état de chargement
        function showLoadingState(show) {
            const existingLoader = document.getElementById('globalLoader');
            if (show && !existingLoader) {
                const loader = document.createElement('div');
                loader.id = 'globalLoader';
                loader.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg';
                loader.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>Chargement...';
                document.body.appendChild(loader);
            } else if (!show && existingLoader) {
                existingLoader.remove();
            }
        }

        // Variables globales
        let currentResponseFormId = null;
        let currentResponseIndex = null;
        let currentResponsePage = 1;
        let responsesPerPage = 10;
        let filteredResponses = [];
        let selectedResponses = new Set();
        let allResponseData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredForms = [];

        // Charger les formulaires de l'utilisateur
        // Charger les formulaires de l'utilisateur depuis l'API
        async function loadForms() {
            try {
                showNotification('Chargement des formulaires...', 'info');
                const forms = await apiService.getForms();
                
                // Mise à jour des données globales
                filteredForms = forms;
                
                // Générer la liste des formulaires
                generateFormsList(forms);
                
                // Mettre à jour les statistiques
                updateStatsFromAPI();
                
                showNotification(`${forms.length} formulaire(s) chargé(s)`, 'success');
                
            } catch (error) {
                console.error('Erreur lors du chargement des formulaires:', error);
                showNotification('Impossible de charger les formulaires. Données d\'exemple utilisées.', 'error');
                
                // Fallback sur les données d'exemple en cas d'erreur
                filteredForms = formsData;
                generateFormsList(formsData);
                updateStats();
            }
        }

        // Nouvelle fonction pour mettre à jour les stats depuis l'API
        async function updateStatsFromAPI() {
            try {
                const stats = await apiService.getDashboardStats();
                
                document.getElementById('totalForms').textContent = stats.totalForms || filteredForms.length;
                document.getElementById('activeForms').textContent = stats.activeForms || filteredForms.filter(f => f.status === 'active').length;
                document.getElementById('totalResponses').textContent = stats.totalResponses || '0';
                document.getElementById('conversionRate').textContent = (stats.conversionRate || 0) + '%';
                
            } catch (error) {
                console.error('Erreur stats API:', error);
                // Fallback sur le calcul local
                updateStats();
            }
        }

        // Données de formulaires d'exemple
        const formsData = [
            {
                id: 1,
                title: "Formulaire de Contact Client",
                description: "Collecte des informations de contact et feedbacks clients",
                type: "manual",
                paymentType: "free",
                status: "active",
                responses: 245,
                views: 1256,
                conversionRate: 19.5,
                createdAt: "2024-12-15",
                lastResponse: "2025-01-08",
                isAI: false
            },
            {
                id: 2,
                title: "Commande Premium - Service Web",
                description: "Formulaire de commande pour services web premium",
                type: "manual",
                paymentType: "paid",
                status: "active",
                responses: 89,
                views: 467,
                conversionRate: 19.1,
                createdAt: "2024-11-20",
                lastResponse: "2025-01-07",
                isAI: false,
                price: 299.99
            },
            {
                id: 3,
                title: "Enquête Satisfaction Client IA",
                description: "Questionnaire intelligent adaptatif généré par IA",
                type: "ai",
                paymentType: "free",
                status: "active",
                responses: 523,
                views: 891,
                conversionRate: 58.7,
                createdAt: "2024-12-01",
                lastResponse: "2025-01-08",
                isAI: true
            },
            {
                id: 4,
                title: "Inscription Formation Avancée",
                description: "Inscription payante pour formation professionnelle",
                type: "manual",
                paymentType: "paid",
                status: "active",
                responses: 156,
                views: 789,
                conversionRate: 19.8,
                createdAt: "2024-10-15",
                lastResponse: "2025-01-06",
                isAI: false,
                price: 499.00
            },
            {
                id: 5,
                title: "Newsletter Inscription",
                description: "Inscription simple à la newsletter mensuelle",
                type: "ai",
                paymentType: "free",
                status: "active",
                responses: 1247,
                views: 2156,
                conversionRate: 57.8,
                createdAt: "2024-09-10",
                lastResponse: "2025-01-08",
                isAI: true
            },
            {
                id: 6,
                title: "Feedback Produit Beta",
                description: "Collecte de retours sur la version bêta du produit",
                type: "manual",
                paymentType: "free",
                status: "draft",
                responses: 0,
                views: 12,
                conversionRate: 0,
                createdAt: "2025-01-05",
                lastResponse: null,
                isAI: false
            },
            {
                id: 7,
                title: "Consultation Personnalisée",
                description: "Réservation de consultations one-to-one payantes",
                type: "ai",
                paymentType: "paid",
                status: "active",
                responses: 67,
                views: 234,
                conversionRate: 28.6,
                createdAt: "2024-11-30",
                lastResponse: "2025-01-04",
                isAI: true,
                price: 150.00
            },
            {
                id: 8,
                title: "Event Registration 2025",
                description: "Inscription pour l'événement annuel de l'entreprise",
                type: "manual",
                paymentType: "free",
                status: "archived",
                responses: 892,
                views: 1456,
                conversionRate: 61.3,
                createdAt: "2024-08-15",
                lastResponse: "2024-12-20",
                isAI: false
            }
        ];

        // Fonction pour ouvrir la modale des réponses - CONNECTÉE À L'API
        async function openResponsesModal(formId) {
            console.log('Ouverture de la modale pour le formulaire:', formId);
            
            const form = formsData.find(f => f.id === formId) || filteredForms.find(f => f.id === formId);
            if (!form) {
                console.error('Formulaire non trouvé:', formId);
                showNotification('Formulaire non trouvé', 'error');
                return;
            }
            
            currentResponseFormId = formId;
            selectedResponses.clear();
            currentResponsePage = 1;
            
            // Vérifier que les éléments de la modale existent
            const modal = document.getElementById('responsesModal');
            const title = document.getElementById('responsesModalTitle');
            const desc = document.getElementById('responsesModalDesc');
            
            if (!modal || !title || !desc) {
                console.error('Éléments de la modale manquants');
                showNotification('Erreur: Éléments de la modale manquants', 'error');
                return;
            }
            
            title.textContent = `Réponses : ${form.title}`;
            desc.textContent = form.description || '';
            
            // Réinitialiser les filtres
            const searchInput = document.getElementById('searchResponses');
            const fieldFilter = document.getElementById('filterByField');
            const sortFilter = document.getElementById('sortResponses');
            
            if (searchInput) searchInput.value = '';
            if (fieldFilter) fieldFilter.value = '';
            if (sortFilter) sortFilter.value = 'newest';
            
            // Cacher les filtres avancés
            const advancedFilters = document.getElementById('advancedFilters');
            if (advancedFilters) {
                advancedFilters.classList.add('hidden');
            }
            
            // Afficher la modale
            modal.classList.remove('hidden');
            
            // Charger les données des réponses depuis l'API
            try {
                showNotification('Chargement des réponses...', 'info');
                
                const responses = await apiService.getFormSubmissions(formId);
                allResponseData = responses;
                filteredResponses = responses;
                
                // Générer le contenu de la table
                renderResponsesTable(formId);
                
                showNotification(`${responses.length} réponse(s) chargée(s)`, 'success');
                console.log('Modale ouverte avec succès - données API chargées');
                
            } catch (error) {
                console.error('Erreur lors du chargement des réponses:', error);
                showNotification('Impossible de charger les réponses. Données d\'exemple utilisées.', 'warning');
                
                // Fallback sur les données d'exemple
                allResponseData = generateSampleResponses();
                filteredResponses = allResponseData;
                renderResponsesTable(formId);
                
                console.log('Modale ouverte avec données d\'exemple');
            }
        }

        // Exposer immédiatement la fonction au niveau global
        window.openResponsesModal = openResponsesModal;

        // Données de test pour les réponses du formulaire de contact
        function generateSampleResponses() {
            const sampleResponses = [
                {
                    id: 1,
                    formId: 1,
                    name: 'Jean Dupont',
                    email: 'jean.dupont@email.com',
                    phone: '+33 1 23 45 67 89',
                    city: 'Paris',
                    profession: 'Développeur',
                    age: 28,
                    service: 'consultation',
                    message: 'Je suis intéressé par vos services de développement web. Pouvez-vous me contacter pour discuter d\'un projet ?',
                    submittedAt: '2025-01-08T10:30:00Z',
                    status: 'pending',
                    validated: false,
                    archived: false
                },
                {
                    id: 2,
                    formId: 1,
                    name: 'Marie Kabila',
                    email: 'marie.kabila@gmail.com',
                    phone: '+33 2 98 76 54 32',
                    city: 'Lyon',
                    profession: 'Manager',
                    age: 35,
                    service: 'formation',
                    message: 'Nous cherchons une solution de formation pour notre équipe.',
                    submittedAt: '2025-01-07T14:20:00Z',
                    status: 'validated',
                    validated: true,
                    archived: false
                },
                {
                    id: 3,
                    formId: 1,
                    name: 'Paul Mbuyi',
                    email: 'paul.mbuyi@yahoo.fr',
                    phone: '+33 4 56 12 37 89',
                    city: 'Marseille',
                    profession: 'Designer',
                    age: 31,
                    service: 'support',
                    message: 'J\'aimerais collaborer sur des projets de design UI/UX.',
                    submittedAt: '2025-01-06T09:15:00Z',
                    status: 'pending',
                    validated: false,
                    archived: false
                },
                {
                    id: 4,
                    formId: 1,
                    name: 'Grace Tshala',
                    email: 'grace.tshala@hotmail.com',
                    phone: '+33 5 70 45 61 23',
                    city: 'Toulouse',
                    profession: 'Commercial',
                    age: 29,
                    service: 'consultation',
                    message: 'Nous avons besoin d\'une stratégie digitale pour notre agence.',
                    submittedAt: '2025-01-05T16:45:00Z',
                    status: 'archived',
                    validated: false,
                    archived: true
                },
                {
                    id: 5,
                    formId: 1,
                    name: 'André Kasongo',
                    email: 'andre.kasongo@outlook.com',
                    phone: '+33 6 12 34 56 78',
                    city: 'Nice',
                    profession: 'Consultant',
                    age: 42,
                    service: 'formation',
                    message: 'Nous souhaitons former nos équipes aux nouvelles technologies.',
                    submittedAt: '2025-01-04T11:30:00Z',
                    status: 'validated',
                    validated: true,
                    archived: false
                },
                {
                    id: 6,
                    formId: 1,
                    name: 'Sophie Martin',
                    email: 'sophie.martin@gmail.com',
                    phone: '+33 7 89 01 23 45',
                    city: 'Paris',
                    profession: 'Développeur',
                    age: 26,
                    service: 'support',
                    message: 'Support technique pour notre application mobile.',
                    submittedAt: '2025-01-03T08:45:00Z',
                    status: 'pending',
                    validated: false,
                    archived: false
                }
            ];
            
            return sampleResponses;
        }

        // Fonction pour afficher les notifications
        function showNotification(message, type = 'info') {
            console.log(`Notification [${type}]:`, message);
            
            // Créer l'élément de notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full opacity-0`;
            
            // Définir les couleurs selon le type
            switch (type) {
                case 'success':
                    notification.className += ' bg-green-500 text-white';
                    break;
                case 'error':
                    notification.className += ' bg-red-500 text-white';
                    break;
                case 'info':
                    notification.className += ' bg-blue-500 text-white';
                    break;
                default:
                    notification.className += ' bg-gray-500 text-white';
            }
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;
            
            // Ajouter au DOM
            document.body.appendChild(notification);
            
            // Animation d'entrée
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            // Auto-suppression après 5 secondes
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Fonction pour générer la liste des formulaires
        function generateFormsList(forms, page = 1) {
            console.log('=== generateFormsList appelée ===');
            console.log('Génération de la liste avec', forms.length, 'formulaires');
            console.log('Forms reçues:', forms);
            
            const list = document.getElementById('formsList');
            console.log('Conteneur formsList trouvé:', list);
            
            if (!list) {
                console.error('ERREUR: Conteneur formsList non trouvé !');
                return;
            }
            
            if (forms.length === 0) {
                console.log('Aucun formulaire à afficher');
                list.innerHTML = `
                    <div class="text-center py-12">
                        <i class="ri-file-list-line text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun formulaire trouvé</h3>
                        <p class="text-gray-500">Essayez de modifier vos filtres ou créez votre premier formulaire.</p>
                    </div>
                `;
                updatePagination(0, page);
                return;
            }

            // Calcul de la pagination
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedForms = forms.slice(startIndex, endIndex);

            const listHTML = paginatedForms.map(form => {
                const statusBadge = getStatusBadge(form.status);
                const typeBadge = getTypeBadge(form);
                const paymentBadge = getPaymentBadge(form);
                
                return `
                    <div class="form-list-item relative p-4 border border-gray-200 rounded-lg hover:border-gray-300 hover:shadow-sm transition-all duration-200" data-form-id="${form.id}">
                        <div class="flex items-center justify-between">
                            <!-- Informations principales -->
                            <div class="flex items-center space-x-4 flex-1 min-w-0">
                                <!-- Icône du formulaire (cliquable) -->
                                <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0 cursor-pointer hover:bg-blue-100" onclick="openResponsesModal(${form.id})">
                                    <i class="ri-file-list-3-line text-blue-600 text-lg"></i>
                                </div>
                                
                                <!-- Détails du formulaire -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-3 mb-1">
                                        <h3 class="text-base font-semibold text-gray-900 truncate cursor-pointer hover:underline" onclick="openResponsesModal(${form.id})">${form.title}</h3>
                                        <div class="flex items-center space-x-2">
                                            ${statusBadge}
                                            ${typeBadge}
                                            ${paymentBadge}
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2 line-clamp-1">${form.description}</p>
                                    
                                    <!-- Statistiques compactes -->
                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                        <span><strong class="text-gray-700">${form.views}</strong> vues</span>
                                        <span><strong class="text-gray-700">${form.responses}</strong> réponses</span>
                                        <span><strong class="text-gray-700">${form.conversionRate}%</strong> conversion</span>
                                        <span class="text-gray-400">•</span>
                                        <span>Créé le ${formatDate(form.createdAt)}</span>
                                        ${form.price ? `<span class="text-green-600 font-medium">${form.price}€</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions toutes en ligne -->
                            <div class="flex items-center space-x-1 ml-4">
                                <button class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" onclick="viewForm(${form.id})" title="Visualiser">
                                    <i class="ri-eye-line text-sm"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" onclick="editForm(${form.id})" title="Éditer">
                                    <i class="ri-edit-line text-sm"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors" onclick="showQRCode(${form.id})" title="QR Code">
                                    <i class="ri-qr-code-line text-sm"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors" onclick="duplicateForm(${form.id})" title="Dupliquer">
                                    <i class="ri-file-copy-line text-sm"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors" onclick="downloadForm(${form.id})" title="Télécharger">
                                    <i class="ri-download-line text-sm"></i>
                                </button>
                                <button class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" onclick="confirmDeleteForm(${form.id})" title="Supprimer">
                                    <i class="ri-delete-bin-line text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');


            console.log('HTML généré, injection dans le DOM');
            list.innerHTML = listHTML;
            console.log('Contenu injecté, éléments cliquables:', document.querySelectorAll('[onclick]').length);
            updatePagination(forms.length, page);
        }

        // Fonction pour mettre à jour la pagination
        function updatePagination(totalItems, currentPageNum) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = currentPageNum;
            
            // Mise à jour des informations
            const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            
            document.getElementById('startItem').textContent = startItem;
            document.getElementById('endItem').textContent = endItem;
            document.getElementById('totalItems').textContent = totalItems;
            
            // Boutons précédent/suivant
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Génération des numéros de page
            const pageNumbers = document.getElementById('pageNumbers');
            let pagesHTML = '';
            
            // Logique pour afficher les numéros de page
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            // Page 1 si pas dans la plage
            if (startPage > 1) {
                pagesHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    pagesHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
            }
            
            // Pages dans la plage
            for (let i = startPage; i <= endPage; i++) {
                pagesHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            // Dernière page si pas dans la plage
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagesHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
                pagesHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            pageNumbers.innerHTML = pagesHTML;
        }

        // Fonctions de navigation
        function goToPage(page) {
            generateFormsList(filteredForms, page);
        }

        function goToPreviousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            const totalPages = Math.ceil(filteredForms.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }

        // Fonctions utilitaires pour les badges (couleurs Tremor simplifiées)
        function getStatusBadge(status) {
            const badges = {
                active: '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">Actif</span>',
                draft: '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full">Brouillon</span>',
                archived: '<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded-full">Archivé</span>'
            };
            return badges[status] || '';
        }

        function getTypeBadge(form) {
            if (form.isAI) {
                return '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">IA</span>';
            }
            return '<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">Manuel</span>';
        }

        function getPaymentBadge(form) {
            if (form.paymentType === 'paid') {
                return '<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-700 rounded-full">Payant</span>';
            }
            return '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">Gratuit</span>';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        // Fonctions d'actions
        function viewForm(formId) {
            const form = formsData.find(f => f.id === formId);
            console.log(`Visualiser le formulaire ${form.title}`);
            
            // Remplir les informations de la modale
            document.getElementById('previewTitle').textContent = form.title;
            document.getElementById('previewDescription').textContent = form.description;
            
            // Générer le contenu du formulaire pour l'aperçu
            const previewContent = generateFormPreview(form);
            document.getElementById('previewContent').innerHTML = previewContent;
            
            // Configurer le bouton d'édition
            const editBtn = document.getElementById('editFromPreview');
            editBtn.onclick = () => {
                document.getElementById('previewModal').classList.add('hidden');
                editForm(formId);
            };
            
            // Afficher la modale
            document.getElementById('previewModal').classList.remove('hidden');
            
            showNotification(`Aperçu du formulaire "${form.title}"`, 'info');
        }

        // Fonction pour générer l'aperçu du formulaire
        function generateFormPreview(form) {
            const statusColor = form.status === 'active' ? 'text-green-600' : 
                               form.status === 'draft' ? 'text-yellow-600' : 'text-gray-600';
            
            return `
                <div class="space-y-6">
                    <!-- Informations du formulaire -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-500">Type</label>
                                <p class="text-sm text-gray-900">${form.isAI ? 'Généré par IA' : 'Créé manuellement'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Statut</label>
                                <p class="text-sm ${statusColor} font-medium">${
                                    form.status === 'active' ? 'Actif' : 
                                    form.status === 'draft' ? 'Brouillon' : 'Archivé'
                                }</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Type de paiement</label>
                                <p class="text-sm text-gray-900">${form.paymentType === 'paid' ? 'Payant' : 'Gratuit'}${form.price ? ` - ${form.price}€` : ''}</p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-500">Date de création</label>
                                <p class="text-sm text-gray-900">${formatDate(form.createdAt)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistiques -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${form.views}</div>
                            <div class="text-sm text-blue-700">Vues</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${form.responses}</div>
                            <div class="text-sm text-green-700">Réponses</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">${form.conversionRate}%</div>
                            <div class="text-sm text-purple-700">Conversion</div>
                        </div>
                    </div>
                    
                    <!-- Aperçu du formulaire -->
                    <div class="border border-gray-200 rounded-lg p-6 bg-white">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Aperçu du formulaire</h4>
                        
                        <form id="previewForm-${form.id}" onsubmit="return false;">
                            ${generateFormFields(form)}
                            

                            <div class="mt-6 flex justify-end">
                                <button type="button" onclick="submitPreviewForm(${form.id})" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                    ${form.paymentType === 'paid' ? `Payer ${form.price}€` : 'Envoyer'}
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    ${form.lastResponse ? `
                        <div class="text-sm text-gray-500">
                            <strong>Dernière réponse :</strong> ${formatDate(form.lastResponse)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Fonction pour générer les champs du formulaire selon le type
        function generateFormFields(form) {
            if (form.isAI) {
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                            <input type="text" name="fullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Votre nom complet">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="votre@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea name="message" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="Votre message..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Évaluation</label>
                            <div class="flex space-x-2">
                                ${[1,2,3,4,5].map(i => `
                                    <label class="cursor-pointer">
                                        <input type="radio" name="rating" value="${i}" class="sr-only">
                                        <div class="w-8 h-8 border border-gray-300 rounded text-sm hover:bg-yellow-100 flex items-center justify-center rating-btn">${i}</div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Formulaire de contact client complet avec tous les champs pour les filtres
                return `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Votre nom">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="votre@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                            <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="+33 1 23 45  67 89">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville *</label>
                            <select name="city" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionnez votre ville</option>
                                <option value="Paris">Paris</option>
                                <option value="Lyon">Lyon</option>
                                <option value="Marseille">Marseille</option>
                                <option value="Toulouse">Toulouse</option>
                                <option value="Nice">Nice</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Profession *</label>
                            <select name="profession" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionnez votre profession</option>
                                <option value="Développeur">Développeur</option>
                                <option value="Designer">Designer</option>
                                <option value="Manager">Manager</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Consultant">Consultant</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âge</label>
                            <input type="number" name="age" min="18" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Votre âge">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Service souhaité</label>
                            <select name="service" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionnez un service</option>
                                <option value="consultation">Consultation</option>
                                <option value="formation">Formation</option>
                                <option value="support">Support technique</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea name="message" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="Décrivez votre demande..."></textarea>
                        </div>
                    </div>
                `;
            }
        }

        // Fonction pour soumettre le formulaire de prévisualisation
        function submitPreviewForm(formId) {
            console.log('submitPreviewForm appelée avec formId:', formId); // Debug
            
            const form = formsData.find(f => f.id === formId);
            const formElement = document.getElementById(`previewForm-${formId}`);
            
            console.log('Formulaire trouvé:', form); // Debug
            console.log('Élément formulaire trouvé:', formElement); // Debug
            
            if (!formElement) {
                showNotification('Erreur : formulaire non trouvé', 'error');
                return;
            }

            // Validation des champs requis
            const requiredFields = formElement.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });

            if (!isValid) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            // Collecte des données du formulaire
            const formData = new FormData(formElement);
            
            // Générer un ID unique pour la réponse
            const existingResponses = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            const newId = Math.max(...existingResponses.map(r => r.id || 0), 0) + 1;
            
            // Créer l'objet de réponse dans le bon format
            const submissionData = {
                id: newId,
                formId: formId,
                name: formData.get('name') || '',
                email: formData.get('email') || '',
                phone: formData.get('phone') || '',
                city: formData.get('city') || '',
                profession: formData.get('profession') || '',
                age: parseInt(formData.get('age')) || null,
                service: formData.get('service') || '',
                message: formData.get('message') || '',
                submittedAt: new Date().toISOString(),
                status: 'pending',
                validated: false,
                archived: false
            };

            // Stockage local des réponses
            let submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            submissions.push(submissionData);
            localStorage.setItem('formSubmissions', JSON.stringify(submissions));

            // Mise à jour des statistiques du formulaire
            form.responses = (form.responses || 0) + 1;
            form.lastResponse = new Date().toISOString().split('T')[0];
            
            // Sauvegarde des données mises à jour
            localStorage.setItem('formsData', JSON.stringify(formsData));

            // Mise à jour de l'affichage
            updateStats();
            filterAndDisplayForms();

            // Gestion du paiement si nécessaire
            if (form.paymentType === 'paid') {
                showNotification(`Redirection vers le paiement de ${form.price}€...`, 'info');
                // Ici vous pourriez intégrer Stripe ou un autre système de paiement
                setTimeout(() => {
                    showNotification('Paiement simulé avec succès !', 'success');
                    document.getElementById('previewModal').classList.add('hidden');
                }, 2000);
            } else {
                showNotification('Formulaire soumis avec succès !', 'success');
                document.getElementById('previewModal').classList.add('hidden');
            }

            // Affichage des données dans la console pour debug
            console.log('Données soumises:', submissionData);
        }

        // Fonction utilitaire pour voir toutes les soumissions (debug)
        function viewAllSubmissions() {
            const submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            console.log('Toutes les soumissions:', submissions);
            return submissions;
        }

        // Fonction pour obtenir les soumissions d'un formulaire spécifique
        function getFormSubmissions(formId) {
            // Vérifier si les données d'exemple existent déjà
            let submissions = JSON.parse(localStorage.getItem('formSubmissions') || '[]');
            
            // Si aucune donnée existe, initialiser avec les exemples
            if (submissions.length === 0) {
                console.log('Initialisation des données d\'exemple...');
                const sampleData = generateSampleResponses();
                localStorage.setItem('formSubmissions', JSON.stringify(sampleData));
                submissions = sampleData;
            }
            
            // Filtrer par formId et retourner
            const formSubmissions = submissions.filter(sub => sub.formId === formId);
            console.log(`Trouvé ${formSubmissions.length} réponses pour le formulaire ${formId}`);
            return formSubmissions;
        }

        function showQRCode(formId) {
            const form = formsData.find(f => f.id === formId);
            console.log(`Afficher QR Code pour ${form.title}`);
            document.getElementById('qrModal').classList.remove('hidden');
        }

        function editForm(formId) {
            const form = formsData.find(f => f.id === formId);
            console.log(`Éditer le formulaire ${form.title}`);
            showNotification(`Redirection vers l'éditeur pour "${form.title}"...`, 'info');
            
            // Redirection vers le éditeur approprié selon le type
            setTimeout(() => {
                if (form.isAI) {
                    // Pour les formulaires IA, rediriger vers le générateur IA
                    window.location.href = `ai-generator.html?edit=${formId}`;
                } else {
                    // Pour les formulaires manuels, rediriger vers le builder
                    window.location.href = `builder.html?edit=${formId}`;
                }
            }, 500);
        }

        async function duplicateForm(formId) {
            try {
                const form = formsData.find(f => f.id === formId) || filteredForms.find(f => f.id === formId);
                if (!form) {
                    showNotification('Formulaire non trouvé', 'error');
                    return;
                }

                showNotification('Duplication en cours...', 'info');

                // Appel API pour dupliquer le formulaire
                const duplicatedForm = await apiService.duplicateForm(formId);

                // Ajouter le formulaire dupliqué aux données locales
                formsData.push(duplicatedForm);
                filteredForms = [...formsData];
                
                // Rafraîchir l'affichage
                filterAndDisplayForms();
                updateStatsFromAPI();
                
                showNotification(`Formulaire "${form.title}" dupliqué avec succès`, 'success');
                
            } catch (error) {
                console.error('Erreur lors de la duplication:', error);
                showNotification('Erreur lors de la duplication. Duplication locale utilisée.', 'warning');
                
                // Fallback: duplication locale
                const form = formsData.find(f => f.id === formId);
                if (form) {
                    const duplicate = {
                        ...form,
                        id: Date.now(),
                        title: `${form.title} (Copie)`,
                        status: 'draft',
                        responses: 0,
                        views: 0,
                        conversionRate: 0,
                        createdAt: new Date().toISOString().split('T')[0],
                        lastResponse: null
                    };
                    
                    formsData.push(duplicate);
                    filteredForms = [...formsData];
                    filterAndDisplayForms();
                    updateStats();
                    showNotification('Formulaire dupliqué localement', 'success');
                }
            }
        }

        function downloadForm(formId) {
            const form = formsData.find(f => f.id === formId);
            console.log(`Télécharger le formulaire ${form.title}`);
            
            // Simulation du téléchargement
            const dataStr = JSON.stringify(form, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `formulaire_${form.id}_${form.title.replace(/\s+/g, '_')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Formulaire téléchargé !', 'success');
        }

        function confirmDeleteForm(formId) {
            window.formToDelete = formId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        async function deleteForm(formId) {
            try {
                const form = formsData.find(f => f.id === formId) || filteredForms.find(f => f.id === formId);
                if (!form) {
                    showNotification('Formulaire non trouvé', 'error');
                    return;
                }

                showNotification('Suppression en cours...', 'info');

                // Appel API pour supprimer le formulaire
                await apiService.deleteForm(formId);

                // Mettre à jour les données locales
                const formIndex = formsData.findIndex(f => f.id === formId);
                if (formIndex > -1) {
                    formsData.splice(formIndex, 1);
                }
                
                // Mettre à jour les formulaires filtrés
                filteredForms = filteredForms.filter(f => f.id !== formId);
                
                // Rafraîchir l'affichage
                filterAndDisplayForms();
                updateStatsFromAPI();
                
                showNotification(`Formulaire "${form.title}" supprimé avec succès`, 'success');
                
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                showNotification('Erreur lors de la suppression du formulaire', 'error');
                
                // En cas d'erreur API, essayer la suppression locale comme fallback
                const formIndex = formsData.findIndex(f => f.id === formId);
                if (formIndex > -1) {
                    const form = formsData[formIndex];
                    formsData.splice(formIndex, 1);
                    filteredForms = [...formsData];
                    filterAndDisplayForms();
                    updateStats();
                    showNotification(`Formulaire "${form.title}" supprimé localement`, 'warning');
                }
            }
        }

        // Fonction pour gérer les filtres et affichage des formulaires
        function filterAndDisplayForms() {
            console.log('Filtrage et affichage des formulaires...');
            
            const typeFilter = document.getElementById('filterType');
            const statusFilter = document.getElementById('filterStatus');
            const searchTerm = document.getElementById('searchForms') ? document.getElementById('searchForms').value.toLowerCase() : '';
            
            const typeFilterValue = typeFilter ? typeFilter.value : '';
            const statusFilterValue = statusFilter ? statusFilter.value : '';
            
            filteredForms = formsData.filter(form => {
                // Filtre par type
                if (typeFilterValue === 'ai' && !form.isAI) return false;
                if (typeFilterValue === 'manual' && form.isAI) return false;
                if (typeFilterValue === 'paid' && form.paymentType !== 'paid') return false;
                if (typeFilterValue === 'free' && form.paymentType !== 'free') return false;
                
                // Filtre par statut
                if (statusFilterValue && statusFilterValue !== form.status) return false;
                
                // Recherche textuelle
                if (searchTerm && !form.title.toLowerCase().includes(searchTerm) && 
                    !form.description.toLowerCase().includes(searchTerm)) return false;
                
                return true;
            });
            
            // Réinitialiser à la première page
            currentPage = 1;
            
            // Générer l'affichage
            generateFormsList(filteredForms, currentPage);
            updateStats();
        }

        // Fonction pour afficher la modale de confirmation de suppression
        function showDeleteModal(formId) {
            console.log('Afficher modale de suppression pour le formulaire:', formId);
            const form = formsData.find(f => f.id === formId);
            if (form) {
                window.formToDelete = formId;
                const modal = document.getElementById('deleteModal');
                if (modal) {
                    modal.classList.remove('hidden');
                } else {
                    // Si la modale n'existe pas, demander confirmation directement
                    if (confirm(`Êtes-vous sûr de vouloir supprimer le formulaire "${form.title}" ?`)) {
                        deleteForm(formId);
                    }
                }
            }
        }

        // Fonction pour exporter toutes les réponses du formulaire
        async function exportAllResponses() {
            if (!currentResponseFormId) {
                showNotification('Aucun formulaire sélectionné', 'error');
                return;
            }

            try {
                showNotification('Export de toutes les réponses en cours...', 'info');

                const response = await apiService.exportSubmissions(currentResponseFormId, null, 'csv');
                
                // Créer le téléchargement
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `toutes_reponses_${currentResponseFormId}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                window.URL.revokeObjectURL(url);

                showNotification('Toutes les réponses exportées avec succès', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'export de toutes les réponses:', error);
                showNotification('Erreur lors de l\'export. Export local utilisé.', 'warning');
                
                // Fallback: export local
                const form = formsData.find(f => f.id === currentResponseFormId);
                if (form && allResponseData.length > 0) {
                    exportToJSON(allResponseData, form);
                } else {
                    showNotification('Aucune donnée à exporter', 'error');
                }
            }
        }

        // Fonction pour afficher la modale de création de formulaire
        function showCreateFormModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Créer un nouveau formulaire</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Titre du formulaire</label>
                            <input type="text" id="formTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Titre du formulaire" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="formDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3" placeholder="Description du formulaire"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type de création</label>
                            <select id="formCreationType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="manual">Créer manuellement</option>
                                <option value="ai">Générer avec IA</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Annuler</button>
                        <button id="createFormBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Créer</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Gestionnaire pour la création
            document.getElementById('createFormBtn').onclick = async () => {
                const title = document.getElementById('formTitle').value.trim();
                const description = document.getElementById('formDescription').value.trim();
                const creationType = document.getElementById('formCreationType').value;

                if (!title) {
                    showNotification('Veuillez saisir un titre', 'error');
                    return;
                }

                try {
                    showNotification('Création du formulaire...', 'info');

                    const formData = {
                        title,
                        description,
                        type: creationType,
                        status: 'draft',
                        isAI: creationType === 'ai'
                    };

                    const newForm = await apiService.createForm(formData);

                    // Ajouter aux données locales
                    formsData.push(newForm);
                    filteredForms = [...formsData];

                    // Rafraîchir l'affichage
                    filterAndDisplayForms();
                    updateStatsFromAPI();

                    modal.remove();
                    showNotification('Formulaire créé avec succès !', 'success');

                    // Rediriger vers l'éditeur approprié
                    setTimeout(() => {
                        if (creationType === 'ai') {
                            window.location.href = `ai-generator.html?edit=${newForm.id}`;
                        } else {
                            window.location.href = `builder.html?edit=${newForm.id}`;
                        }
                    }, 1000);

                } catch (error) {
                    console.error('Erreur lors de la création:', error);
                    showNotification('Erreur lors de la création du formulaire', 'error');
                }
            };
        }

        // === GESTIONNAIRES D'ÉVÉNEMENTS POUR LA CONNEXION API ===

        // Initialisation de la page avec chargement API
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INITIALISATION DE LA PAGE AVEC API ===');
            
            // Charger les formulaires depuis l'API
            loadForms();
            
            // Configurer les gestionnaires d'événements pour les filtres
            const filterType = document.getElementById('filterType');
            const filterStatus = document.getElementById('filterStatus');
            const searchForms = document.getElementById('searchForms');
            
            if (filterType) {
                filterType.addEventListener('change', filterAndDisplayForms);
            }
            
            if (filterStatus) {
                filterStatus.addEventListener('change', filterAndDisplayForms);
            }
            
            if (searchForms) {
                searchForms.addEventListener('input', debounce(filterAndDisplayForms, 300));
            }
            
            console.log('Gestionnaires d\'événements configurés');
        });

        // Fonction utilitaire pour debounce (éviter trop d'appels API)
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Refactorer openResponsesModal pour utiliser l'API
        const originalOpenResponsesModal = window.openResponsesModal;
        window.openResponsesModal = async function(formId) {
            try {
                showNotification('Chargement des réponses...', 'info');
                
                // Charger les réponses depuis l'API
                const responses = await apiService.getFormSubmissions(formId);
                allResponseData = responses;
                filteredResponses = responses;
                
                // Appeler la fonction originale
                originalOpenResponsesModal(formId);
                
                showNotification(`${responses.length} réponse(s) chargée(s)`, 'success');
                
            } catch (error) {
                console.error('Erreur lors du chargement des réponses:', error);
                showNotification('Erreur lors du chargement des réponses. Données d\'exemple utilisées.', 'error');
                
                // Fallback sur les données d'exemple
                allResponseData = generateSampleResponses();
                filteredResponses = allResponseData;
                originalOpenResponsesModal(formId);
            }
        };

        // Fonction pour rafraîchir les données depuis l'API
        async function refreshData() {
            try {
                showNotification('Actualisation en cours...', 'info');
                await loadForms();
                showNotification('Données actualisées', 'success');
            } catch (error) {
                console.error('Erreur lors de l\'actualisation:', error);
                showNotification('Erreur lors de l\'actualisation', 'error');
            }
        }

        // Ajouter un bouton de rafraîchissement (optionnel)
        window.refreshData = refreshData;

        // Gestion de la déconnexion automatique en cas d'erreur 401
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('401')) {
                console.log('Token expiré, redirection vers la connexion');
                localStorage.removeItem('token');
                window.location.href = '../auth/login.html';
            }
        });

        console.log('=== SPRINT 1 : CONNEXION API TERMINÉE ===');
        console.log('✅ Service API centralisé créé');
        console.log('✅ Chargement des formulaires depuis l\'API');
        console.log('✅ CRUD formulaires connecté à l\'API');
        console.log('✅ Gestion des réponses connectée à l\'API');
        console.log('✅ Actions groupées connectées à l\'API');
        console.log('✅ Création de formulaires connectée à l\'API');
        console.log('✅ Export/Import connecté à l\'API');
        console.log('✅ Gestion d\'erreurs et fallbacks implémentés');
    </script>
</body>
</html>