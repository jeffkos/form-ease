/**
 * üß™ FormEase - Script de Test des Nouveaux Champs
 * Test et validation de tous les types de champs du Form Builder
 */

class FormBuilderTester {
    constructor() {
        this.testResults = {};
        this.formBuilder = null;
    }

    async runAllTests() {
        console.log('üß™ D√©marrage des tests du Form Builder...');
        
        // Attendre que le FormBuilder soit initialis√©
        if (window.formBuilder) {
            this.formBuilder = window.formBuilder;
        } else {
            console.error('‚ùå FormBuilder non trouv√©');
            return;
        }

        const tests = [
            this.testBasicFields(),
            this.testSelectionFields(), 
            this.testDateTimeFields(),
            this.testAdvancedFields(),
            this.testPaymentFields(),
            this.testLayoutFields(),
            this.testPremiumValidation(),
            this.testFieldRendering(),
            this.testFieldValidation(),
            this.testFieldPersistence()
        ];

        try {
            await Promise.all(tests);
            this.displayTestResults();
        } catch (error) {
            console.error('‚ùå Erreur lors des tests:', error);
        }
    }

    async testBasicFields() {
        console.log('üìù Test des champs de base...');
        
        const basicFieldTypes = [
            'text', 'textarea', 'email', 'number_only', 
            'address', 'website', 'hidden'
        ];

        const results = [];
        
        for (const fieldType of basicFieldTypes) {
            try {
                // Tester l'ajout du champ
                this.formBuilder.addFieldFromTemplate(fieldType);
                
                // V√©rifier que le champ a √©t√© ajout√©
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                const isAdded = !!field;
                
                // V√©rifier le rendu
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                results.push({
                    type: fieldType,
                    added: isAdded,
                    preview: hasPreview,
                    success: isAdded && hasPreview
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${isAdded && hasPreview ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    added: false,
                    preview: false,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.basicFields = results;
    }

    async testSelectionFields() {
        console.log('üéØ Test des champs de s√©lection...');
        
        const selectionFieldTypes = [
            'select', 'radio', 'checkbox', 'slider', 'rating'
        ];

        const results = [];
        
        for (const fieldType of selectionFieldTypes) {
            try {
                this.formBuilder.addFieldFromTemplate(fieldType);
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                
                // Tests sp√©cifiques aux champs de s√©lection
                const hasOptions = fieldType === 'slider' || fieldType === 'rating' ? 
                    !!field.settings : field.options && field.options.length > 0;
                
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                results.push({
                    type: fieldType,
                    added: !!field,
                    hasOptions,
                    preview: hasPreview,
                    success: !!field && hasOptions && hasPreview
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${!!field && hasOptions && hasPreview ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.selectionFields = results;
    }

    async testDateTimeFields() {
        console.log('üìÖ Test des champs de date et heure...');
        
        const dateTimeFieldTypes = ['date', 'time', 'publish_date'];
        const results = [];
        
        for (const fieldType of dateTimeFieldTypes) {
            try {
                this.formBuilder.addFieldFromTemplate(fieldType);
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                // V√©rifier les √©l√©ments sp√©cifiques
                const hasDateInput = preview.includes('type="date"') || 
                                   preview.includes('type="time"') || 
                                   preview.includes('type="datetime-local"');
                
                results.push({
                    type: fieldType,
                    added: !!field,
                    preview: hasPreview,
                    hasDateInput,
                    success: !!field && hasPreview && hasDateInput
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${!!field && hasPreview && hasDateInput ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.dateTimeFields = results;
    }

    async testAdvancedFields() {
        console.log('‚öôÔ∏è Test des champs avanc√©s...');
        
        const advancedFieldTypes = [
            'file', 'signature', 'captcha', 'html', 'calculations'
        ];
        
        const results = [];
        
        for (const fieldType of advancedFieldTypes) {
            try {
                this.formBuilder.addFieldFromTemplate(fieldType);
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                // V√©rifications sp√©cifiques
                let specificCheck = true;
                if (fieldType === 'signature') {
                    specificCheck = preview.includes('Signature √©lectronique');
                } else if (fieldType === 'captcha') {
                    specificCheck = preview.includes('robot');
                } else if (fieldType === 'html') {
                    specificCheck = preview.includes('HTML');
                } else if (fieldType === 'calculations') {
                    specificCheck = preview.includes('Calcul');
                }
                
                results.push({
                    type: fieldType,
                    added: !!field,
                    preview: hasPreview,
                    specificCheck,
                    success: !!field && hasPreview && specificCheck
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${!!field && hasPreview && specificCheck ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.advancedFields = results;
    }

    async testPaymentFields() {
        console.log('üí≥ Test des champs de paiement...');
        
        const paymentFieldTypes = ['currency', 'stripe_payment', 'paypal_payment'];
        const results = [];
        
        for (const fieldType of paymentFieldTypes) {
            try {
                this.formBuilder.addFieldFromTemplate(fieldType);
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                // V√©rifications sp√©cifiques aux paiements
                let paymentCheck = true;
                if (fieldType === 'currency') {
                    paymentCheck = preview.includes('‚Ç¨') || preview.includes('$');
                } else if (fieldType === 'stripe_payment') {
                    paymentCheck = preview.includes('Stripe');
                } else if (fieldType === 'paypal_payment') {
                    paymentCheck = preview.includes('PayPal');
                }
                
                results.push({
                    type: fieldType,
                    added: !!field,
                    preview: hasPreview,
                    paymentCheck,
                    success: !!field && hasPreview && paymentCheck
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${!!field && hasPreview && paymentCheck ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.paymentFields = results;
    }

    async testLayoutFields() {
        console.log('üìê Test des √©l√©ments de structure...');
        
        const layoutFieldTypes = ['section', 'field_group', 'page_break', 'consent'];
        const results = [];
        
        for (const fieldType of layoutFieldTypes) {
            try {
                this.formBuilder.addFieldFromTemplate(fieldType);
                const field = this.formBuilder.formFields.find(f => f.type === fieldType);
                
                const preview = this.formBuilder.renderFieldPreview(field);
                const hasPreview = !!preview && preview.length > 0;
                
                // V√©rifications sp√©cifiques √† la structure
                let structureCheck = true;
                if (fieldType === 'section') {
                    structureCheck = preview.includes('border-l-4');
                } else if (fieldType === 'page_break') {
                    structureCheck = preview.includes('page');
                } else if (fieldType === 'consent') {
                    structureCheck = preview.includes('checkbox');
                }
                
                results.push({
                    type: fieldType,
                    added: !!field,
                    preview: hasPreview,
                    structureCheck,
                    success: !!field && hasPreview && structureCheck
                });
                
                console.log(`  ‚úÖ ${fieldType}: ${!!field && hasPreview && structureCheck ? 'OK' : 'ERREUR'}`);
                
            } catch (error) {
                console.error(`  ‚ùå ${fieldType}: ${error.message}`);
                results.push({
                    type: fieldType,
                    success: false,
                    error: error.message
                });
            }
        }
        
        this.testResults.layoutFields = results;
    }

    async testPremiumValidation() {
        console.log('üëë Test de la validation Premium...');
        
        // Simuler un utilisateur non-premium
        const originalCheckPremium = this.formBuilder.checkPremiumAccess;
        this.formBuilder.checkPremiumAccess = () => false;
        
        try {
            // Compter les modals avant
            const modalsBefore = document.querySelectorAll('.fixed').length;
            
            // Essayer d'ajouter un champ premium
            this.formBuilder.addFieldFromTemplate('signature');
            
            // Compter les modals apr√®s
            const modalsAfter = document.querySelectorAll('.fixed').length;
            
            const premiumModalShown = modalsAfter > modalsBefore;
            
            this.testResults.premiumValidation = {
                modalShown: premiumModalShown,
                success: premiumModalShown
            };
            
            console.log(`  ‚úÖ Validation Premium: ${premiumModalShown ? 'OK' : 'ERREUR'}`);
            
            // Nettoyer les modals
            document.querySelectorAll('.fixed').forEach(modal => {
                if (modal.innerHTML.includes('Premium')) {
                    modal.remove();
                }
            });
            
        } catch (error) {
            console.error(`  ‚ùå Validation Premium: ${error.message}`);
            this.testResults.premiumValidation = {
                modalShown: false,
                success: false,
                error: error.message
            };
        } finally {
            // Restaurer la fonction originale
            this.formBuilder.checkPremiumAccess = originalCheckPremium;
        }
    }

    async testFieldRendering() {
        console.log('üé® Test du rendu des champs...');
        
        const field = {
            id: 'test_field',
            type: 'text',
            label: 'Test Field',
            placeholder: 'Test placeholder',
            required: true
        };
        
        try {
            const preview = this.formBuilder.renderFieldPreview(field);
            const hasInput = preview.includes('<input');
            const hasPlaceholder = preview.includes('Test placeholder');
            
            this.testResults.fieldRendering = {
                hasPreview: !!preview,
                hasInput,
                hasPlaceholder,
                success: !!preview && hasInput && hasPlaceholder
            };
            
            console.log(`  ‚úÖ Rendu des champs: ${!!preview && hasInput && hasPlaceholder ? 'OK' : 'ERREUR'}`);
            
        } catch (error) {
            console.error(`  ‚ùå Rendu des champs: ${error.message}`);
            this.testResults.fieldRendering = {
                hasPreview: false,
                success: false,
                error: error.message
            };
        }
    }

    async testFieldValidation() {
        console.log('‚úÖ Test de la validation des champs...');
        
        try {
            // Tester diff√©rents types de validation
            const emailField = { type: 'email', validation: { pattern: 'email' } };
            const numberField = { type: 'number_only', validation: { min: 0, max: 100 } };
            
            const hasEmailValidation = emailField.validation.pattern === 'email';
            const hasNumberValidation = numberField.validation.min !== undefined;
            
            this.testResults.fieldValidation = {
                emailValidation: hasEmailValidation,
                numberValidation: hasNumberValidation,
                success: hasEmailValidation && hasNumberValidation
            };
            
            console.log(`  ‚úÖ Validation: ${hasEmailValidation && hasNumberValidation ? 'OK' : 'ERREUR'}`);
            
        } catch (error) {
            console.error(`  ‚ùå Validation: ${error.message}`);
            this.testResults.fieldValidation = {
                success: false,
                error: error.message
            };
        }
    }

    async testFieldPersistence() {
        console.log('üíæ Test de la persistance des champs...');
        
        try {
            const initialFieldCount = this.formBuilder.formFields.length;
            
            // Ajouter un champ
            this.formBuilder.addFieldFromTemplate('text');
            const afterAddCount = this.formBuilder.formFields.length;
            
            // V√©rifier l'ajout
            const fieldAdded = afterAddCount > initialFieldCount;
            
            // V√©rifier que le champ a les bonnes propri√©t√©s
            const lastField = this.formBuilder.formFields[this.formBuilder.formFields.length - 1];
            const hasRequiredProps = lastField && lastField.id && lastField.type && lastField.label;
            
            this.testResults.fieldPersistence = {
                fieldAdded,
                hasRequiredProps,
                success: fieldAdded && hasRequiredProps
            };
            
            console.log(`  ‚úÖ Persistance: ${fieldAdded && hasRequiredProps ? 'OK' : 'ERREUR'}`);
            
        } catch (error) {
            console.error(`  ‚ùå Persistance: ${error.message}`);
            this.testResults.fieldPersistence = {
                success: false,
                error: error.message
            };
        }
    }

    displayTestResults() {
        console.log('\nüìä R√âSULTATS DES TESTS');
        console.log('==========================================');
        
        let totalTests = 0;
        let passedTests = 0;
        
        Object.entries(this.testResults).forEach(([category, results]) => {
            console.log(`\n${this.getCategoryIcon(category)} ${category.toUpperCase()}`);
            console.log('------------------------------------------');
            
            if (Array.isArray(results)) {
                results.forEach(result => {
                    totalTests++;
                    if (result.success) passedTests++;
                    console.log(`  ${result.success ? '‚úÖ' : '‚ùå'} ${result.type}: ${result.success ? 'PASS' : 'FAIL'}`);
                    if (result.error) {
                        console.log(`     Erreur: ${result.error}`);
                    }
                });
            } else {
                totalTests++;
                if (results.success) passedTests++;
                console.log(`  ${results.success ? '‚úÖ' : '‚ùå'} ${category}: ${results.success ? 'PASS' : 'FAIL'}`);
                if (results.error) {
                    console.log(`     Erreur: ${results.error}`);
                }
            }
        });
        
        const successRate = Math.round((passedTests / totalTests) * 100);
        
        console.log('\n==========================================');
        console.log(`üìà SCORE GLOBAL: ${passedTests}/${totalTests} (${successRate}%)`);
        console.log(`${successRate >= 90 ? 'üéâ EXCELLENT' : successRate >= 70 ? 'üëç BON' : '‚ö†Ô∏è √Ä AM√âLIORER'}`);
        
        // Afficher dans une notification visuelle
        this.showVisualResults(passedTests, totalTests, successRate);
    }

    getCategoryIcon(category) {
        const icons = {
            basicFields: 'üìù',
            selectionFields: 'üéØ',
            dateTimeFields: 'üìÖ',
            advancedFields: '‚öôÔ∏è',
            paymentFields: 'üí≥',
            layoutFields: 'üìê',
            premiumValidation: 'üëë',
            fieldRendering: 'üé®',
            fieldValidation: '‚úÖ',
            fieldPersistence: 'üíæ'
        };
        return icons[category] || 'üîß';
    }

    showVisualResults(passed, total, rate) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-white rounded-lg shadow-xl p-6 border z-50 max-w-sm';
        notification.innerHTML = `
            <div class="text-center">
                <div class="text-4xl mb-2">${rate >= 90 ? 'üéâ' : rate >= 70 ? 'üëç' : '‚ö†Ô∏è'}</div>
                <h3 class="text-lg font-bold mb-2">Tests Form Builder</h3>
                <div class="text-2xl font-bold ${rate >= 90 ? 'text-green-600' : rate >= 70 ? 'text-blue-600' : 'text-orange-600'} mb-2">
                    ${rate}%
                </div>
                <p class="text-gray-600 mb-4">${passed}/${total} tests r√©ussis</p>
                <button onclick="this.parentElement.parentElement.remove()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Fermer
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-suppression apr√®s 10 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 10000);
    }
}

// Fonction globale pour lancer les tests
window.testFormBuilder = function() {
    const tester = new FormBuilderTester();
    tester.runAllTests();
};

// Fonction pour tester un type sp√©cifique
window.testFieldType = function(fieldType) {
    if (window.formBuilder) {
        console.log(`üß™ Test du type: ${fieldType}`);
        try {
            window.formBuilder.addFieldFromTemplate(fieldType);
            const field = window.formBuilder.formFields.find(f => f.type === fieldType);
            if (field) {
                const preview = window.formBuilder.renderFieldPreview(field);
                console.log(`‚úÖ ${fieldType} ajout√© et rendu avec succ√®s`);
                console.log('Preview:', preview.substring(0, 100) + '...');
            } else {
                console.error(`‚ùå ${fieldType} non trouv√© apr√®s ajout`);
            }
        } catch (error) {
            console.error(`‚ùå Erreur avec ${fieldType}:`, error);
        }
    }
};

console.log('üß™ Testeur Form Builder charg√©. Utilisez testFormBuilder() pour lancer tous les tests.');
console.log('üí° Ou testFieldType("nom_du_type") pour tester un type sp√©cifique.');
